<!DOCTYPE html>
<html class="no-js" lang="zxx">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Kelola Module - Edumark</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/css/admin-dashboard.css" />
    <link rel="stylesheet" href="assets/css/course-modules.css" />
  </head>

  <body class="admin-body">
    <div class="modules-container">
      <a href="instructor-dashboard.html" class="back-link"
        >‚Üê Kembali ke Dashboard</a
      >

      <div class="header">
        <h2>
          Kelola Module
          <span
            id="course-title"
            style="color: #667eea; font-size: 18px"
          ></span>
        </h2>
        <button class="btn-add" onclick="goToAddModule()">
          <i class="fa fa-plus"></i> Tambah Module
        </button>
      </div>

      <div id="alert-error" class="alert alert-error"></div>
      <div id="alert-success" class="alert alert-success"></div>

      <div class="modules-list">
        <div id="modules-list-content">
          <div class="empty-state">
            <i class="fa fa-inbox"></i>
            <p>Belum ada module</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/vendor/jquery-1.12.4.min.js"></script>
    <script type="module">
      import {
        getCoursDetail,
        deleteModule,
      } from "./assets/js/api/instructor.js";

      let courseId = null;
      let modules = [];

      // Get course ID from URL params
      function getCourseIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
      }

      async function loadModules() {
        courseId = getCourseIdFromUrl();
        if (!courseId) {
          showAlert("Course ID tidak ditemukan", "error");
          return;
        }

        document.getElementById(
          "course-title"
        ).textContent = `(Kursus #${courseId})`;

        try {
          // Fetch course detail which includes modules
          const courseData = await getCoursDetail(courseId);
          modules = courseData.modules || [];
          renderModules();
        } catch (err) {
          console.error("Error loading modules:", err);
          // Fallback to localStorage for offline support
          modules = JSON.parse(
            localStorage.getItem(`course-${courseId}-modules`) || "[]"
          );
          renderModules();
        }
      }

      function renderModules() {
        const container = document.getElementById("modules-list-content");

        if (modules.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fa fa-inbox"></i>
              <p>Belum ada module. Klik "Tambah Module" untuk memulai.</p>
            </div>
          `;
          return;
        }

        const sorted = [...modules].sort(
          (a, b) => (a.order || 0) - (b.order || 0)
        );
        container.innerHTML = sorted
          .map(
            (m) => `
          <div class="module-item">
            <div class="module-info">
              <h4>#${m.order || "-"} ${m.title}</h4>
              <p>${m.pdf_url ? "üìÑ Ada PDF" : "Tanpa PDF"}</p>
            </div>
            <div class="module-actions">
              <button class="btn-sm btn-primary-sm" onclick="editModule(${
                m.id || "null"
              })">Edit</button>
              <button class="btn-sm btn-primary-sm" onclick="goToQuizzes(${
                m.id || "null"
              })">Quiz</button>
              <button class="btn-sm btn-danger-sm" onclick="deleteModule(${
                m.id || "null"
              })">Hapus</button>
            </div>
          </div>
        `
          )
          .join("");
      }

      window.goToAddModule = function () {
        const courseId = getCourseIdFromUrl();
        if (!courseId) {
          showAlert("Course ID tidak ditemukan", "error");
          return;
        }
        window.location.href = `module-form.html?courseId=${courseId}`;
      };

      window.editModule = function (id) {
        const courseId = getCourseIdFromUrl();
        if (!courseId) {
          showAlert("Course ID tidak ditemukan", "error");
          return;
        }
        window.location.href = `module-form.html?courseId=${courseId}&moduleId=${id}`;
      };

      window.deleteModule = async function (id) {
        if (!confirm("Apakah Anda yakin ingin menghapus module ini?")) return;

        try {
          // Call API to delete module
          await deleteModule(courseId, id);

          // Remove from local modules list
          modules = modules.filter((m) => m.id !== id);

          // Update localStorage as backup
          localStorage.setItem(
            `course-${courseId}-modules`,
            JSON.stringify(modules)
          );

          renderModules();
          showAlert("Module berhasil dihapus", "success");
        } catch (error) {
          console.error("Error deleting module:", error);
          showAlert("Gagal menghapus module: " + error.message, "error");
        }
      };

      window.goToQuizzes = function (moduleId) {
        if (!moduleId) {
          showAlert("Simpan module terlebih dahulu", "error");
          return;
        }
        window.location.href = `course-quiz.html?courseId=${courseId}&moduleId=${moduleId}`;
      };

      function showAlert(message, type) {
        const errorAlert = document.getElementById("alert-error");
        const successAlert = document.getElementById("alert-success");

        if (type === "error") {
          errorAlert.textContent = message;
          errorAlert.style.display = "block";
          successAlert.style.display = "none";
        } else {
          successAlert.textContent = message;
          successAlert.style.display = "block";
          errorAlert.style.display = "none";
        }
      }

      // Reload modules when page becomes visible (user returns from module-form page)
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          loadModules();
        }
      });

      document.addEventListener("DOMContentLoaded", loadModules);
    </script>
    </script>
  </body>
</html>
