<!DOCTYPE html>
<html class="no-js" lang="zxx">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Form Module - Edumark</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/css/admin-dashboard.css" />
    <style>
      body {
        background: #f5f7fa;
      }

      .form-container {
        max-width: 700px;
        margin: 40px auto;
        padding: 0 20px;
      }

      .form-card {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .form-card h2 {
        margin-top: 0;
        margin-bottom: 30px;
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group small {
        display: block;
        color: #666;
        margin-top: 6px;
        font-size: 13px;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 30px;
        justify-content: flex-end;
      }

      .btn-submit,
      .btn-cancel {
        padding: 10px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }

      .btn-submit {
        background: #667eea;
        color: white;
      }

      .btn-submit:hover:not(:disabled) {
        background: #5568d3;
      }

      .btn-submit:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .btn-cancel {
        background: #ddd;
        color: #333;
      }

      .btn-cancel:hover {
        background: #ccc;
      }

      .alert {
        padding: 12px 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
        font-size: 14px;
      }

      .alert-error {
        background: #fee;
        color: #c33;
        border: 1px solid #fcc;
      }

      .alert-success {
        background: #efe;
        color: #3c3;
        border: 1px solid #cfc;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>

  <body class="admin-body">
    <div class="form-container">
      <a id="back-link" href="course-modules.html" class="back-link"
        >‚Üê Kembali ke Kelola Module</a
      >

      <div id="alert-error" class="alert alert-error"></div>
      <div id="alert-success" class="alert alert-success"></div>

      <div class="form-card">
        <h2 id="form-title">Tambah Module</h2>

        <form id="module-form">
          <div class="form-group">
            <label for="module-title">Judul Module *</label>
            <input
              type="text"
              id="module-title"
              required
              placeholder="Contoh: Pengenalan HTML"
            />
          </div>

          <div class="form-group">
            <label for="module-order">Urutan *</label>
            <input
              type="number"
              id="module-order"
              required
              placeholder="1"
              min="1"
              value="1"
            />
          </div>

          <div class="form-group">
            <label for="module-pdf">File PDF (Opsional)</label>
            <input type="file" id="module-pdf" accept=".pdf" />
            <small>Ukuran maksimal: 10MB</small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="goBack()">
              Batal
            </button>
            <button type="submit" class="btn-submit">Simpan Module</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/vendor/jquery-1.12.4.min.js"></script>
    <script type="module">
      import {
        addModule,
        editModule,
        getCoursDetail,
      } from "./assets/js/api/instructor.js";

      let courseId = null;
      let moduleId = null;
      let existingModule = null;

      // Get URL parameters
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        courseId = params.get("courseId");
        moduleId = params.get("moduleId");
      }

      // Initialize page
      async function initPage() {
        getUrlParams();

        if (!courseId) {
          showAlert("Course ID tidak ditemukan", "error");
          return;
        }

        // Update back link
        document.getElementById(
          "back-link"
        ).href = `course-modules.html?id=${courseId}`;

        // If editing, load module data from API
        if (moduleId) {
          try {
            const courseData = await getCoursDetail(courseId);
            const modules = courseData.modules || [];
            existingModule = modules.find((m) => m.id == moduleId);

            if (existingModule) {
              document.getElementById("form-title").textContent = "Edit Module";
              document.getElementById("module-title").value =
                existingModule.title || "";
              document.getElementById("module-order").value =
                existingModule.order || 1;
            } else {
              showAlert("Module tidak ditemukan", "error");
            }
          } catch (err) {
            console.error("Error loading module:", err);
            showAlert("Gagal memuat data module", "error");
          }
        }

        // Form submit handler
        document
          .getElementById("module-form")
          .addEventListener("submit", handleSubmit);
      }

      async function handleSubmit(e) {
        e.preventDefault();

        const title = document.getElementById("module-title").value.trim();
        const order = parseInt(document.getElementById("module-order").value);
        const pdfFile = document.getElementById("module-pdf").files[0];

        if (!title) {
          showAlert("Judul module harus diisi", "error");
          return;
        }

        if (!order || order < 1) {
          showAlert("Urutan harus berupa angka positif", "error");
          return;
        }

        try {
          const submitBtn = document.querySelector(".btn-submit");
          submitBtn.disabled = true;
          submitBtn.textContent = "Menyimpan...";

          // Create FormData for file upload
          const formData = new FormData();
          formData.append("title", title);
          formData.append("order", order.toString());
          if (pdfFile) {
            formData.append("pdf", pdfFile);
          }

          if (moduleId) {
            // Update existing module via API
            await editModule(courseId, moduleId, formData);
          } else {
            // Create new module via API
            await addModule(courseId, formData);
          }

          showAlert(
            moduleId
              ? "Module berhasil diperbarui"
              : "Module berhasil ditambahkan",
            "success"
          );

          // Redirect back after 1.5 seconds
          setTimeout(() => {
            window.location.href = `course-modules.html?id=${courseId}`;
          }, 1500);
        } catch (error) {
          console.error("Error:", error);
          showAlert("Gagal menyimpan module: " + error.message, "error");
          document.querySelector(".btn-submit").disabled = false;
          document.querySelector(".btn-submit").textContent = "Simpan Module";
        }
      }

      function goBack() {
        window.location.href = `course-modules.html?id=${courseId}`;
      }

      function showAlert(message, type) {
        const errorAlert = document.getElementById("alert-error");
        const successAlert = document.getElementById("alert-success");

        if (type === "error") {
          errorAlert.textContent = message;
          errorAlert.style.display = "block";
          successAlert.style.display = "none";
        } else {
          successAlert.textContent = message;
          successAlert.style.display = "block";
          errorAlert.style.display = "none";
        }
      }

      document.addEventListener("DOMContentLoaded", initPage);
    </script>
  </body>
</html>
